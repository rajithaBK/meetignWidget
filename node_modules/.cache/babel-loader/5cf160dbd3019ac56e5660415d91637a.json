{"ast":null,"code":"\"use strict\";\n\nvar _Object$defineProperty = require(\"@babel/runtime-corejs2/core-js/object/define-property\");\n\nvar _interopRequireDefault = require(\"@babel/runtime-corejs2/helpers/interopRequireDefault\");\n\n_Object$defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nexports.default = void 0;\n\nvar _slicedToArray2 = _interopRequireDefault(require(\"@babel/runtime-corejs2/helpers/slicedToArray\"));\n\nvar _symbol = _interopRequireDefault(require(\"@babel/runtime-corejs2/core-js/symbol\"));\n\nvar _now = _interopRequireDefault(require(\"@babel/runtime-corejs2/core-js/date/now\"));\n\nvar _promise = _interopRequireDefault(require(\"@babel/runtime-corejs2/core-js/promise\"));\n\nvar _apply = _interopRequireDefault(require(\"@babel/runtime-corejs2/core-js/reflect/apply\"));\n\nvar _webexCore = require(\"@webex/webex-core\");\n\nvar _commonTimers = require(\"@webex/common-timers\");\n/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\n\nvar sym = (0, _symbol.default)('metric id');\n\nvar MetricsBatcher = _webexCore.Batcher.extend({\n  namespace: 'Metrics',\n  prepareItem: function prepareItem(item) {\n    // Keep non-prod data out of metrics\n    var env = process.env.NODE_ENV === 'production' ? null : 'TEST';\n    item.appType = item.appType || this.config.appType;\n    item.env = item.env || env;\n    item.time = item.time || (0, _now.default)();\n    item.version = item.version || this.webex.version;\n    return _promise.default.resolve(item);\n  },\n  prepareRequest: function prepareRequest(queue) {\n    return _promise.default.resolve(queue.map(function (item) {\n      item.postTime = item.postTime || (0, _now.default)();\n      return item;\n    }));\n  },\n  submitHttpRequest: function submitHttpRequest(payload) {\n    return this.webex.request({\n      method: 'POST',\n      service: 'metrics',\n      resource: 'metrics',\n      body: {\n        metrics: payload\n      }\n    });\n  },\n  handleHttpSuccess: function handleHttpSuccess(res) {\n    var _this = this;\n\n    return _promise.default.all(res.options.body.metrics.map(function (item) {\n      return _this.acceptItem(item);\n    }));\n  },\n  handleHttpError: function handleHttpError(reason) {\n    var _this2 = this;\n\n    if (reason instanceof _webexCore.WebexHttpError.NetworkOrCORSError) {\n      this.logger.warn('metrics-batcher: received network error submitting metrics, reenqueuing payload');\n      return _promise.default.all(reason.options.body.metrics.map(function (item) {\n        return new _promise.default(function (resolve) {\n          var delay = item[sym].nextDelay;\n\n          if (delay < _this2.config.batcherRetryPlateau) {\n            item[sym].nextDelay *= 2;\n          }\n\n          (0, _commonTimers.safeSetTimeout)(function () {\n            resolve(_this2.rerequest(item));\n          }, delay);\n        });\n      }));\n    }\n\n    return (0, _apply.default)(_webexCore.Batcher.prototype.handleHttpError, this, [reason]);\n  },\n  rerequest: function rerequest(item) {\n    var _this3 = this;\n\n    return _promise.default.all([this.getDeferredForRequest(item), this.prepareItem(item)]).then(function (_ref) {\n      var _ref2 = (0, _slicedToArray2.default)(_ref, 2),\n          defer = _ref2[0],\n          req = _ref2[1];\n\n      _this3.enqueue(req).then(function () {\n        return _this3.bounce();\n      }).catch(function (reason) {\n        return defer.reject(reason);\n      });\n    });\n  },\n  fingerprintRequest: function fingerprintRequest(item) {\n    item[sym] = item[sym] || {\n      nextDelay: 1000\n    };\n    return _promise.default.resolve(item[sym]);\n  },\n  fingerprintResponse: function fingerprintResponse(item) {\n    return _promise.default.resolve(item[sym]);\n  }\n});\n\nvar _default = MetricsBatcher;\nexports.default = _default;","map":{"version":3,"mappings":"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","names":["sym","MetricsBatcher","Batcher","extend","namespace","prepareItem","item","env","process","NODE_ENV","appType","config","time","version","webex","_promise","resolve","prepareRequest","queue","map","postTime","submitHttpRequest","payload","request","method","service","resource","body","metrics","handleHttpSuccess","res","all","options","_this","acceptItem","handleHttpError","reason","WebexHttpError","NetworkOrCORSError","logger","warn","delay","nextDelay","_this2","batcherRetryPlateau","rerequest","prototype","getDeferredForRequest","then","defer","req","_this3","enqueue","bounce","catch","reject","fingerprintRequest","fingerprintResponse"],"sources":["batcher.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {Batcher, WebexHttpError} from '@webex/webex-core';\nimport {safeSetTimeout} from '@webex/common-timers';\n\nconst sym = Symbol('metric id');\n\nconst MetricsBatcher = Batcher.extend({\n  namespace: 'Metrics',\n\n  prepareItem(item) {\n    // Keep non-prod data out of metrics\n    const env = process.env.NODE_ENV === 'production' ? null : 'TEST';\n\n    item.appType = item.appType || this.config.appType;\n    item.env = item.env || env;\n    item.time = item.time || Date.now();\n    item.version = item.version || this.webex.version;\n\n    return Promise.resolve(item);\n  },\n\n  prepareRequest(queue) {\n    return Promise.resolve(queue.map((item) => {\n      item.postTime = item.postTime || Date.now();\n\n      return item;\n    }));\n  },\n\n  submitHttpRequest(payload) {\n    return this.webex.request({\n      method: 'POST',\n      service: 'metrics',\n      resource: 'metrics',\n      body: {\n        metrics: payload\n      }\n    });\n  },\n\n  handleHttpSuccess(res) {\n    return Promise.all(res.options.body.metrics.map((item) => this.acceptItem(item)));\n  },\n\n  handleHttpError(reason) {\n    if (reason instanceof WebexHttpError.NetworkOrCORSError) {\n      this.logger.warn('metrics-batcher: received network error submitting metrics, reenqueuing payload');\n\n      return Promise.all(reason.options.body.metrics.map((item) => new Promise((resolve) => {\n        const delay = item[sym].nextDelay;\n\n        if (delay < this.config.batcherRetryPlateau) {\n          item[sym].nextDelay *= 2;\n        }\n        safeSetTimeout(() => {\n          resolve(this.rerequest(item));\n        }, delay);\n      })));\n    }\n\n    return Reflect.apply(Batcher.prototype.handleHttpError, this, [reason]);\n  },\n\n  rerequest(item) {\n    return Promise.all([\n      this.getDeferredForRequest(item),\n      this.prepareItem(item)\n    ])\n      .then(([defer, req]) => {\n        this.enqueue(req)\n          .then(() => this.bounce())\n          .catch((reason) => defer.reject(reason));\n      });\n  },\n\n  fingerprintRequest(item) {\n    item[sym] = item[sym] || {\n      nextDelay: 1000\n    };\n\n    return Promise.resolve(item[sym]);\n  },\n\n  fingerprintResponse(item) {\n    return Promise.resolve(item[sym]);\n  }\n});\n\nexport default MetricsBatcher;\n"]},"metadata":{},"sourceType":"script"}