{"ast":null,"code":"\"use strict\";\n\nvar _Object$defineProperty = require(\"@babel/runtime-corejs2/core-js/object/define-property\");\n\nvar _interopRequireDefault = require(\"@babel/runtime-corejs2/helpers/interopRequireDefault\");\n\n_Object$defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nexports.default = oneFlight;\n\nvar _weakMap = _interopRequireDefault(require(\"@babel/runtime-corejs2/core-js/weak-map\"));\n\nvar _map = _interopRequireDefault(require(\"@babel/runtime-corejs2/core-js/map\"));\n\nvar _apply = _interopRequireDefault(require(\"@babel/runtime-corejs2/core-js/reflect/apply\"));\n\nvar _promise = _interopRequireDefault(require(\"@babel/runtime-corejs2/core-js/promise\"));\n\nvar _typeof2 = _interopRequireDefault(require(\"@babel/runtime-corejs2/helpers/typeof\"));\n\nvar _wrap2 = _interopRequireDefault(require(\"lodash/wrap\"));\n\nvar _templateContainer = _interopRequireDefault(require(\"./template-container\")); // Alias Map and WeakMap to get around a babel compiler bug\n\n\nvar W = _weakMap.default;\nvar M = _map.default;\nvar WeakMappedMappedMap = (0, _templateContainer.default)(W, M, M);\nvar flights = new WeakMappedMappedMap();\n/**\n * @memberof Util\n * @param {Object} options\n * @param {Function} options.keyFactory\n * @param {boolean} options.cacheFailures\n * @param {boolean} options.cacheSuccesses\n * @returns {Function}\n */\n\nfunction oneFlight() {\n  for (var _len = arguments.length, params = new Array(_len), _key = 0; _key < _len; _key++) {\n    params[_key] = arguments[_key];\n  }\n\n  if (params.length === 3) {\n    return (0, _apply.default)(oneFlightDecorator, null, params);\n  }\n\n  var options = params[0] || {};\n  var cacheFailures = options.cacheFailures,\n      cacheSuccesses = options.cacheSuccesses,\n      keyFactory = options.keyFactory;\n  return oneFlightDecorator;\n  /**\n   * @param {Object} target\n   * @param {string} prop\n   * @param {Object} descriptor\n   * @private\n   * @returns {Object}\n   */\n\n  function oneFlightDecorator(target, prop, descriptor) {\n    var key = prop;\n    descriptor.value = (0, _wrap2.default)(descriptor.value, function oneFlightExecutor(fn) {\n      var _this = this;\n\n      var innerKey = key;\n\n      for (var _len2 = arguments.length, args = new Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {\n        args[_key2 - 1] = arguments[_key2];\n      }\n\n      if (keyFactory) {\n        innerKey = \"\".concat(innerKey, \"_\").concat(keyFactory.apply(void 0, args));\n      }\n      /* eslint no-invalid-this: [0] */\n\n\n      var flight = flights.get(this, target, innerKey);\n\n      if (flight) {\n        return flight;\n      }\n\n      flight = (0, _apply.default)(fn, this, args);\n\n      if (!cacheFailures && flight && flight.catch) {\n        flight = flight.catch(function (reason) {\n          flights.delete(_this, target, innerKey);\n          return _promise.default.reject(reason);\n        });\n      }\n\n      if (!cacheSuccesses && flight && flight.then) {\n        flight = flight.then(function (result) {\n          flights.delete(_this, target, innerKey);\n          return result;\n        });\n      }\n\n      flights.set(this, target, innerKey, flight);\n      return flight;\n    }); // This *should* make decorators compatible with AmpersandState class\n    // definitions\n\n    if ((0, _typeof2.default)(target) === 'object' && !target.prototype) {\n      target[prop] = descriptor.value;\n    }\n\n    return descriptor;\n  }\n}","map":{"version":3,"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAMA,iF,CAEA;;;AACA,IAAMA,CAAC,mBAAP;AACA,IAAMC,CAAC,eAAP;AACA,IAAMC,mBAAmB,GAAG,gCAAKF,CAAL,EAAQC,CAAR,EAAWA,CAAX,CAA5B;AAEA,IAAME,OAAO,GAAG,IAAID,mBAAJ,EAAhB;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACe,SAASE,SAAT,GAA8B;AAAA,oCAARC,MAAQ;AAARA,UAAQ,MAARA,GAAQC,eAARD;AAAQ;;AAC3C,MAAIA,MAAM,CAACE,MAAPF,KAAkB,CAAtB,EAAyB;AACvB,WAAO,oBAAcG,kBAAd,EAAkC,IAAlC,EAAwCH,MAAxC,CAAP;AACD;;AAED,MAAMI,OAAO,GAAGJ,MAAM,CAAC,CAAD,CAANA,IAAa,EAA7B;AAEA,MACEK,aADF,GAIID,OAJJ,CACEC,aADF;AAAA,MAEEC,cAFF,GAIIF,OAJJ,CAEEE,cAFF;AAAA,MAGEC,UAHF,GAIIH,OAJJ,CAGEG,UAHF;AAMA,SAAOJ,kBAAP;AAEA;AACF;AACA;AACA;AACA;AACA;AACA;;AACE,WAASA,kBAAT,CAA4BK,MAA5B,EAAoCC,IAApC,EAA0CC,UAA1C,EAAsD;AACpD,QAAMC,GAAG,GAAGF,IAAZ;AAEAC,cAAU,CAACE,KAAXF,GAAmB,oBAAKA,UAAU,CAACE,KAAhB,EAAuB,SAASC,iBAAT,CAA2BC,EAA3B,EAAwC;AAAA;;AAChF,UAAIC,QAAQ,GAAGJ,GAAf;;AADgF,yCAANK,IAAM;AAANA,YAAM,WAANA,GAAMf,gBAANe;AAAM;;AAGhF,UAAIT,UAAJ,EAAgB;AACdQ,gBAAQ,aAAMA,QAAN,cAAkBR,UAAU,MAAVA,SAAcS,IAAdT,CAAlB,CAARQ;AACD;AAED;;;AACA,UAAIE,MAAM,GAAGnB,OAAO,CAACoB,GAARpB,CAAY,IAAZA,EAAkBU,MAAlBV,EAA0BiB,QAA1BjB,CAAb;;AAEA,UAAImB,MAAJ,EAAY;AACV,eAAOA,MAAP;AACD;;AAEDA,YAAM,GAAG,oBAAcH,EAAd,EAAkB,IAAlB,EAAwBE,IAAxB,CAATC;;AACA,UAAI,CAACZ,aAAD,IAAkBY,MAAlB,IAA4BA,MAAM,CAACE,KAAvC,EAA8C;AAC5CF,cAAM,GAAGA,MAAM,CAACE,KAAPF,CAAa,UAACG,MAAD,EAAY;AAChCtB,iBAAO,CAACuB,MAARvB,CAAewB,KAAfxB,EAAqBU,MAArBV,EAA6BiB,QAA7BjB;AAEA,iBAAOyB,iBAAQC,MAAR,CAAeJ,MAAf,CAAP;AAHO,UAATH;AAKD;;AAED,UAAI,CAACX,cAAD,IAAmBW,MAAnB,IAA6BA,MAAM,CAACQ,IAAxC,EAA8C;AAC5CR,cAAM,GAAGA,MAAM,CAACQ,IAAPR,CAAY,UAACS,MAAD,EAAY;AAC/B5B,iBAAO,CAACuB,MAARvB,CAAewB,KAAfxB,EAAqBU,MAArBV,EAA6BiB,QAA7BjB;AAEA,iBAAO4B,MAAP;AAHO,UAATT;AAKD;;AAEDnB,aAAO,CAAC6B,GAAR7B,CAAY,IAAZA,EAAkBU,MAAlBV,EAA0BiB,QAA1BjB,EAAoCmB,MAApCnB;AAEA,aAAOmB,MAAP;AAjCiB,MAAnBP,CAHoD,CAuCpD;AACA;;AACA,QAAI,sBAAOF,MAAP,MAAkB,QAAlB,IAA8B,CAACA,MAAM,CAACoB,SAA1C,EAAqD;AACnDpB,YAAM,CAACC,IAAD,CAAND,GAAeE,UAAU,CAACE,KAA1BJ;AACD;;AAED,WAAOE,UAAP;AACD;AACF","names":["W","M","WeakMappedMappedMap","flights","oneFlight","params","arguments","length","oneFlightDecorator","options","cacheFailures","cacheSuccesses","keyFactory","target","prop","descriptor","key","value","oneFlightExecutor","fn","innerKey","args","flight","get","catch","reason","delete","_this","_promise","reject","then","result","set","prototype"],"sources":["one-flight.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {wrap} from 'lodash';\n\nimport make from './template-container';\n\n// Alias Map and WeakMap to get around a babel compiler bug\nconst W = WeakMap;\nconst M = Map;\nconst WeakMappedMappedMap = make(W, M, M);\n\nconst flights = new WeakMappedMappedMap();\n\n/**\n * @memberof Util\n * @param {Object} options\n * @param {Function} options.keyFactory\n * @param {boolean} options.cacheFailures\n * @param {boolean} options.cacheSuccesses\n * @returns {Function}\n */\nexport default function oneFlight(...params) {\n  if (params.length === 3) {\n    return Reflect.apply(oneFlightDecorator, null, params);\n  }\n\n  const options = params[0] || {};\n\n  const {\n    cacheFailures,\n    cacheSuccesses,\n    keyFactory\n  } = options;\n\n  return oneFlightDecorator;\n\n  /**\n   * @param {Object} target\n   * @param {string} prop\n   * @param {Object} descriptor\n   * @private\n   * @returns {Object}\n   */\n  function oneFlightDecorator(target, prop, descriptor) {\n    const key = prop;\n\n    descriptor.value = wrap(descriptor.value, function oneFlightExecutor(fn, ...args) {\n      let innerKey = key;\n\n      if (keyFactory) {\n        innerKey = `${innerKey}_${keyFactory(...args)}`;\n      }\n\n      /* eslint no-invalid-this: [0] */\n      let flight = flights.get(this, target, innerKey);\n\n      if (flight) {\n        return flight;\n      }\n\n      flight = Reflect.apply(fn, this, args);\n      if (!cacheFailures && flight && flight.catch) {\n        flight = flight.catch((reason) => {\n          flights.delete(this, target, innerKey);\n\n          return Promise.reject(reason);\n        });\n      }\n\n      if (!cacheSuccesses && flight && flight.then) {\n        flight = flight.then((result) => {\n          flights.delete(this, target, innerKey);\n\n          return result;\n        });\n      }\n\n      flights.set(this, target, innerKey, flight);\n\n      return flight;\n    });\n\n    // This *should* make decorators compatible with AmpersandState class\n    // definitions\n    if (typeof target === 'object' && !target.prototype) {\n      target[prop] = descriptor.value;\n    }\n\n    return descriptor;\n  }\n}\n"]},"metadata":{},"sourceType":"script"}